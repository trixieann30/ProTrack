{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Manage Quiz: {{ quiz.title }} - ProTrack{% endblock %}

{% block extra_css %}
<style>
.edit-question-inline {
    display: none !important;
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    background-color: #f9f9f9;
}
.edit-question-inline.show {
    display: block !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{% url 'dashboard:course_detail' material.course.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Course
        </a>
    </div>

    <h2 class="mb-4">Manage Quiz: {{ quiz.title }}</h2>
    
    <!-- Quiz Status Banner -->
    {% if quiz.is_published %}
    <div class="alert alert-success mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-check-circle me-2"></i>
                <strong>Published</strong> - Users can take this quiz
            </div>
            <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="unpublish_quiz">
                <button type="submit" class="btn btn-sm btn-outline-warning">Unpublish to Edit</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-edit me-2"></i>
                <strong>Editing Mode</strong> - Users see "Material is being edited" and cannot take this quiz yet
            </div>
            {% if questions.count >= quiz.target_question_count %}
            <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="publish_quiz">
                <button type="submit" class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i>Publish Quiz</button>
            </form>
            {% else %}
            <span class="badge bg-secondary">Need {{ quiz.target_question_count }} questions ({{ questions.count }} added)</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Quiz Info Card -->
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Course:</strong> {{ material.course.title }} | 
        <strong>Pass Mark:</strong> {{ quiz.pass_mark }}% | 
        <strong>Questions:</strong> {{ questions.count }} / {{ quiz.target_question_count }}
        <div class="progress mt-2" style="height: 8px;">
            <div class="progress-bar {% if questions.count >= quiz.target_question_count %}bg-success{% else %}bg-primary{% endif %}" 
                 role="progressbar" 
                 style="width: {% widthratio questions.count quiz.target_question_count 100 %}%"
                 aria-valuenow="{{ questions.count }}" 
                 aria-valuemin="0" 
                 aria-valuemax="{{ quiz.target_question_count }}"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quiz Settings</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_settings">
                        <div class="row align-items-end">
                            <div class="col-md-4">
                                <label for="target_question_count" class="form-label">Target Number of Questions</label>
                                <input type="number" id="target_question_count" name="target_question_count" class="form-control" value="{{ quiz.target_question_count }}" min="1" max="100" required>
                                <small class="text-muted">How many questions you want in this quiz</small>
                            </div>
                            <div class="col-md-4">
                                <label for="pass_mark" class="form-label">Passing Percentage</label>
                                <input type="number" id="pass_mark" name="pass_mark" class="form-control" value="{{ quiz.pass_mark }}" min="0" max="100" required>
                                <small class="text-muted">Minimum score to pass (%)</small>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary">Update Settings</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Questions for {{ quiz.title }}</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 d-flex justify-content-end">
                        <button id="saveAllBtn" class="btn btn-success">Save Changes</button>
                    </div>

                    {% for question in questions %}
                        <div id="questionBlock-{{ question.id }}" class="mb-4 border-bottom pb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ forloop.counter }}. <span class="question-preview" data-qid="{{ question.id }}">{{ question.text }}</span></strong> ({{ question.get_question_type_display }})
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-toggle-btn" data-qid="{{ question.id }}">Edit</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-question-btn" data-qid="{{ question.id }}">Delete</button>
                                </div>
                            </div>

                            {% if question.question_type == 'multiple_choice' %}
                                <ul class="list-unstyled mt-2 choices-list" id="choicesList-{{ question.id }}">
                                    {% for choice in question.choices.all %}
                                        <li class="choice-item {% if choice.is_correct %}text-success fw-bold{% endif %}" data-choice-id="{{ choice.id }}">
                                            {{ choice.text }}
                                            {% if choice.is_correct %}<i class="fas fa-check ms-2"></i>{% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                                <form method="post" class="row g-2 align-items-center mt-2 add-choice-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="add_choice">
                                    <input type="hidden" name="question_id" value="{{ question.id }}">
                                    <div class="col-auto">
                                        <input type="text" name="text" class="form-control form-control-sm add-choice-text" placeholder="Add a choice" required>
                                    </div>
                                    <div class="col-auto">
                                        <div class="form-check">
                                            <input class="form-check-input add-choice-correct" type="checkbox" name="is_correct" value="true">
                                            <label class="form-check-label">Correct</label>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-sm btn-secondary">Add Choice</button>
                                    </div>
                                </form>
                            {% else %}
                                <p class="mt-2"><strong>Correct Answer:</strong> <span class="correct-answer-display text-success fw-bold" data-qid="{{ question.id }}">{{ question.correct_answer|default:"Not set" }}</span></p>
                            {% endif %}

                            <!-- Inline Edit Form (replaces modal) -->
                            <div class="edit-question-inline mt-3" id="editQuestionInline-{{ question.id }}">
                                <form method="post" class="edit-question-form" data-qid="{{ question.id }}">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="edit_question">
                                    <input type="hidden" name="question_id" value="{{ question.id }}">
                                    <div class="mb-3">
                                        <label for="text-{{ question.id }}" class="form-label">Question Text</label>
                                        <textarea id="text-{{ question.id }}" name="text" class="form-control edit-question-text" rows="3" required>{{ question.text }}</textarea>
                                    </div>
                                    {% if question.question_type != 'multiple_choice' %}
                                        <div class="mb-3">
                                            <label for="correct_answer-{{ question.id }}" class="form-label">Correct Answer</label>
                                            {% if question.question_type == 'true_false' %}
                                                <select id="correct_answer-{{ question.id }}" name="correct_answer" class="form-select edit-question-correct" required>
                                                    <option value="True" {% if question.correct_answer == 'True' %}selected{% endif %}>True</option>
                                                    <option value="False" {% if question.correct_answer == 'False' %}selected{% endif %}>False</option>
                                                </select>
                                            {% else %}
                                                <input type="text" id="correct_answer-{{ question.id }}" name="correct_answer" class="form-control edit-question-correct" value="{{ question.correct_answer|default:'' }}" required>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    <div class="mb-3">
                                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                                        <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" data-qid="{{ question.id }}">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% empty %}
                        <p>No questions have been added to this quiz yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Add New Question</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="text" class="form-label">Question Text</label>
                            <textarea class="form-control" id="text" name="text" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="question_type" class="form-label">Question Type</label>
                            <select class="form-select" id="question_type" name="question_type">
                                <option value="multiple_choice">Multiple Choice</option>
                                <option value="true_false">True/False</option>
                                <option value="fill_in_the_blanks">Fill in the Blanks</option>
                                <option value="identification">Identification</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Question</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    // Server-resolved URLs (ensure dashboard:delete_question exists)
    const QUESTION_DELETE_URL = "{% url 'dashboard:delete_question' %}";

    // Helper: get CSRF token value from the page
    function getCsrfToken(){
        const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return el ? el.value : null;
    }

    // Helper to post FormData and expect JSON
    function fetchJson(url, formData){
        return fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        }).then(resp => {
            const ct = resp.headers.get('content-type') || '';
            if(ct.includes('application/json')) return resp.json();
            throw new Error('Server returned non-JSON response');
        });
    }

    // ---------- Delete question handler (delegated) ----------
    document.addEventListener('click', function(e){
        const btn = e.target.matches('.delete-question-btn') ? e.target : (e.target.closest ? e.target.closest('.delete-question-btn') : null);
        if(!btn) return;

        e.preventDefault();
        const qid = btn.getAttribute('data-qid');
        if(!qid) return;
        if(!confirm('Delete this question? This action cannot be undone.')) return;

        const fd = new FormData();
        fd.append('question_id', qid);
        const csrftoken = getCsrfToken();
        if(csrftoken) fd.append('csrfmiddlewaretoken', csrftoken);

        fetchJson(QUESTION_DELETE_URL, fd).then(data => {
            if(data && data.success){
                // remove the question block from the DOM
                const block = document.getElementById('questionBlock-'+qid);
                if(block) block.remove();
            } else {
                alert('Failed to delete question: ' + (data && data.message ? data.message : 'Unknown error'));
            }
        }).catch(err => {
            alert('Network error: ' + err.message);
        });
    });

    // ---------- Existing handlers (unchanged) ----------
    // Save all button (unchanged)
    const saveAllBtn = document.getElementById('saveAllBtn');
    if(saveAllBtn){
        saveAllBtn.addEventListener('click', function(e){
            e.preventDefault();

            // Build a POST form for bulk save
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '';

            // CSRF token
            const csrftokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if(csrftokenInput){
                const csrftoken = csrftokenInput.value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrftoken;
                form.appendChild(csrfInput);
            }

            // action
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'save_all';
            form.appendChild(actionInput);

            // For each question form, pull values
            document.querySelectorAll('.edit-question-form').forEach(function(qform){
                const qid = qform.querySelector('input[name="question_id"]').value;
                const textEl = qform.querySelector('.edit-question-text');
                if(textEl){
                    const inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = `question_${qid}_text`;
                    inp.value = textEl.value;
                    form.appendChild(inp);
                }

                const correctEl = qform.querySelector('.edit-question-correct');
                if(correctEl){
                    const inp2 = document.createElement('input');
                    inp2.type = 'hidden';
                    inp2.name = `question_${qid}_correct`;
                    inp2.value = correctEl.value;
                    form.appendChild(inp2);
                }
            });

            document.body.appendChild(form);
            form.submit();
        });
    }

    // ---------- Attach handlers once (avoid nested registrations) ----------
    // 1) Submit handlers for inline edit forms
    document.querySelectorAll('.edit-question-form').forEach(function(form){
        form.addEventListener('submit', function(e){
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            if(submitBtn) submitBtn.disabled = true;

            const fd = new FormData(form);
            if(!fd.get('action')) fd.set('action', 'edit_question');

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: fd
            }).then(response => {
                const ct = response.headers.get('content-type') || '';
                if(ct.includes('application/json')) return response.json();
                throw new Error('Server returned non-JSON response');
            }).then(data => {
                if(data && data.success){
                    const qid = data.question_id;
                    const preview = document.querySelector('.question-preview[data-qid="'+qid+'"]');
                    if(preview && data.text) preview.textContent = data.text;

                    if(data.correct_answer !== undefined){
                        const display = document.querySelector('.correct-answer-display[data-qid="'+qid+'"]');
                        if(display) display.textContent = (data.correct_answer || 'Not set');
                    }

                    // Hide inline form reliably
                    const inlineEl = document.getElementById('editQuestionInline-'+qid);
                    if(inlineEl){
                        inlineEl.classList.remove('show');
                    }

                    // Remove focus to avoid accidental re-open
                    if(document.activeElement) document.activeElement.blur();
                } else {
                    alert('Failed to save question: ' + (data && data.message ? data.message : 'Unknown error'));
                }
            }).catch(err => {
                alert('Network error: ' + err.message);
            }).finally(() => {
                if(submitBtn) submitBtn.disabled = false;
            });
        });
    });

    // 2) Delegate click handler for Edit toggle buttons (single handler)
    document.addEventListener('click', function(e){
        const btn = e.target.matches('.edit-toggle-btn') ? e.target : e.target.closest && e.target.closest('.edit-toggle-btn');
        if(!btn) return;
        e.preventDefault();
        e.stopPropagation();

        const qid = btn.getAttribute('data-qid');
        const inline = document.getElementById('editQuestionInline-'+qid);

        if(!inline) return;

        inline.classList.toggle('show');

        // focus the textarea when showing
        if(inline.classList.contains('show')){
            setTimeout(function(){
                const ta = inline.querySelector('.edit-question-text');
                if(ta) ta.focus();
            }, 50);
        }
    });

    // 3) Delegate click handler for Cancel buttons
    document.addEventListener('click', function(e){
        const btn = e.target.matches('.cancel-edit-btn') ? e.target : e.target.closest && e.target.closest('.cancel-edit-btn');
        if(!btn) return;
        e.preventDefault();
        const qid = btn.getAttribute('data-qid');
        const inline = document.getElementById('editQuestionInline-'+qid);
        if(inline) inline.classList.remove('show');
    });

    // 4) Attach add-choice-form submit handlers once
    document.querySelectorAll('.add-choice-form').forEach(function(form){
        form.addEventListener('submit', function(e){
            e.preventDefault();
            const fd = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            if(submitBtn) submitBtn.disabled = true;

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: fd
            }).then(response => {
                const ct = response.headers.get('content-type') || '';
                if(ct.includes('application/json')) return response.json();
                throw new Error('Server returned non-JSON response');
            }).then(data => {
                if(data && data.success){
                    const qid = fd.get('question_id');
                    const choicesList = document.getElementById('choicesList-'+qid);
                    if(choicesList){
                        const li = document.createElement('li');
                        li.className = 'choice-item' + (data.is_correct ? ' text-success fw-bold' : '');
                        li.setAttribute('data-choice-id', data.choice_id);
                        li.innerHTML = data.text + (data.is_correct ? '<i class="fas fa-check ms-2"></i>' : '');
                        choicesList.appendChild(li);
                    }
                    // Clear the form
                    form.reset();
                } else {
                    alert('Failed to add choice: ' + (data && data.message ? data.message : 'Unknown error'));
                }
            }).catch(err => {
                alert('Network error: ' + err.message);
            }).finally(() => {
                if(submitBtn) submitBtn.disabled = false;
            });
        });
    });

});
</script>
{% endblock %}
