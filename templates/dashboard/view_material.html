{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}{{ material.title }} - ProTrack{% endblock %}

{% block extra_css %}
<style>
    .viewer-container {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .viewer-header {
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .file-viewer {
        width: 100%;
        min-height: 600px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .file-viewer iframe,
    .file-viewer embed,
    .file-viewer video {
        width: 100%;
        height: 600px;
        border: none;
    }
    
    .completion-banner {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        display: none;
    }
    
    .completion-banner.show {
        display: block;
        animation: slideDown 0.5s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{% url 'dashboard:course_detail' enrollment.course.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Course
        </a>
    </div>
    
    <!-- Completion Banner -->
    <div id="completionBanner" class="completion-banner {% if is_completed %}show{% endif %}">
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle fa-2x me-3"></i>
            <div>
                <h5 class="mb-0">✓ Material Completed</h5>
                <p class="mb-0">You have successfully completed this material</p>
            </div>
        </div>
    </div>
    
    <!-- Viewer Container -->
    <div class="viewer-container">
        <div class="viewer-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2>{{ material.title }}</h2>
                    <p class="text-muted mb-0">{{ material.get_material_type_display }}</p>
                    {% if material.description %}
                        <p class="mt-2">{{ material.description }}</p>
                    {% endif %}
                </div>
                <div>
                    {% if is_completed %}
                        <span class="badge bg-success" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                            <i class="fas fa-check-circle me-2"></i>Completed
                        </span>
                    {% else %}
                        <span class="badge bg-warning" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                            <i class="fas fa-eye me-2"></i>Viewing...
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- File Viewer -->
        {% if is_viewable %}
            <div class="file-viewer" id="fileViewer">
                {% if file_extension == '.pdf' %}
                    <iframe src="{{ material.file_url }}" id="pdfFrame"></iframe>
                {% elif file_extension in '.jpg,.jpeg,.png,.gif' %}
                    <img src="{{ material.file_url }}" alt="{{ material.title }}" style="width: 100%; height: auto;">
                {% elif file_extension in '.mp4,.webm' %}
                    <video controls id="videoPlayer" style="width: 100%; height: auto;">
                        <source src="{{ material.file_url }}" type="video/{{ file_extension|slice:'1:' }}">
                        Your browser does not support the video tag.
                    </video>
                {% endif %}
            </div>
            
            <!-- Auto-mark complete after viewing -->
            {% if not is_completed %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    This material will be automatically marked as complete after you've viewed it.
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-file fa-4x text-muted mb-3"></i>
                <h4>Preview Not Available</h4>
                <p class="text-muted mb-4">This file type cannot be previewed in the browser.</p>
                <a href="{{ material.file_url }}" download="{{ material.file_name }}" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Download File
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isCompleted = JSON.parse('{{ is_completed|lower }}');
    const isViewable = JSON.parse('{{ is_viewable|lower }}');
    
    if (!isCompleted && isViewable) {
        // Track viewing time
        let viewingTime = 0;
        let marked = false;
        
        // Set interval to check viewing time
        const viewTimer = setInterval(function() {
            viewingTime++;
            
            // Mark as complete after 10 seconds of viewing
            if (viewingTime >= 10 && !marked) {
                marked = true;
                markAsComplete();
                clearInterval(viewTimer);
            }
        }, 1000);
        
        // For videos, mark complete when video ends
        const video = document.getElementById('videoPlayer');
        if (video) {
            video.addEventListener('ended', function() {
                if (!marked) {
                    marked = true;
                    markAsComplete();
                    clearInterval(viewTimer);
                }
            });
        }
        
        // For PDFs, check if user scrolled through it
        const pdfFrame = document.getElementById('pdfFrame');
        if (pdfFrame) {
            // Mark complete after 30 seconds for PDFs (assuming they're reading)
            setTimeout(function() {
                if (!marked) {
                    marked = true;
                    markAsComplete();
                    clearInterval(viewTimer);
                }
            }, 30000);
        }
        
        function markAsComplete() {
            const csrfToken = getCsrfToken();
            console.log('CSRF Token found:', csrfToken ? 'Yes' : 'No');

            fetch('{% url "dashboard:mark_material_viewed" enrollment.id material.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                const ct = response.headers.get('content-type') || '';
                console.log('Content type:', ct);

                if (ct.includes('application/json')) {
                    return response.json();
                }
                // non-json (HTML) - reload to handle redirects
                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('Server returned HTML error');
                }
            })
            .then(data => {
                console.log('Response data:', data);
                if (data && data.success) {
                    // Show completion banner
                    const banner = document.getElementById('completionBanner');
                    if (banner) {
                        banner.classList.add('show');
                    }

                    // Show success message
                    alert('✓ Material marked as complete!\n\nProgress: ' + data.progress + '%');

                    // Optionally redirect back to course
                    setTimeout(function() {
                        window.location.href = '{% url "dashboard:course_detail" enrollment.course.id %}';
                    }, 2000);
                } else if (data) {
                    console.error('Server returned error:', data.error);
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error marking complete:', error);
                alert('Failed to mark material as complete. Please try again.');
            });
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check for exact match
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Alternative CSRF token sources
    function getCsrfToken() {
        // Try different cookie names
        let token = getCookie('csrftoken') || getCookie('csrf_token') || getCookie('csrfmiddlewaretoken');

        // Try to get from meta tag
        if (!token) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                token = metaTag.getAttribute('content');
            }
        }

        // Try to get from form
        if (!token) {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                token = csrfInput.value;
            }
        }

        return token;
    }
});
</script>
{% endblock %}